<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的宠物 - 区块链宠物保险管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #4CAF50;
            padding: 10px;
            text-align: center;
            color: white;
        }

        .nav {
            background-color: #333;
            overflow: hidden;
        }

        .nav a {
            float: left;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        .nav a:hover {
            background-color: #ddd;
            color: black;
        }

        .nav a i {
            margin-right: 8px;
        }

        .content {
            margin: 15px;
        }

        .footer {
            background-color: #f1f1f1;
            padding: 10px;
            text-align: center;
        }

        .pet-item {
            border: 1px solid #ddd;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 5px;
        }

        .pet-item h3 {
            margin-top: 0;
        }

        .alert {
            display: none;
        }
    </style>
</head>
<body>
<div class="header">
    <h1><i class="fas fa-paw"></i> 区块链宠物保险管理系统</h1>
</div>
<div class="nav">
    <a href="{% url 'dashboard' %}"><i class="fas fa-home"></i>首页</a>
    <a href="{% url 'policy_list' %}"><i class="fas fa-shield-alt"></i>保险服务</a>
    <a href="{% url 'profile' %}"><i class="fas fa-user"></i>个人中心</a>
    <a href="{% url 'my_pets' %}"><i class="fas fa-paw"></i>我的宠物</a>
    <a href="{% url 'my_policies' %}"><i class="fas fa-file-alt"></i>我的保险</a>
    <a href="{% url 'contact' %}"><i class="fas fa-envelope"></i>联系我们</a>
    <a href="{% url 'login' %}" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a >
</div>

<div class="content">
    <h2>我的宠物</h2>
    <div class="alert alert-success" role="alert" id="success-alert"></div>
    <div class="alert alert-danger" role="alert" id="error-alert"></div>

    <form id="add-pet-form">
        <h3>添加宠物</h3>
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">添加</button>
    </form>

    <div class="row" id="pets-list">
        {% for pet in pets %}
        <div class="col-md-4 pet-item" id="pet-{{ pet.id }}">
            <h3>{{ pet.name }}</h3>
            <p>物种: {{ pet.species }}</p>
            <p>年龄: {{ pet.age }}</p>
            <p>性别: {{ pet.gender }}</p>
            <button class="btn btn-secondary edit-pet-btn" data-id="{{ pet.id }}">编辑</button>
            <button class="btn btn-danger delete-pet-btn" data-id="{{ pet.id }}">删除</button>
        </div>
        {% endfor %}
    </div>
</div>

<div class="footer">
    <p>版权所有 © 2024 区块链宠物保险管理系统</p>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        // CSRF token setup for AJAX
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Function to show alerts
        function showAlert(message, type) {
            const alert = type === 'success' ? $('#success-alert') : $('#error-alert');
            alert.text(message).show().delay(3000).fadeOut();
        }

        // Add pet
        $('#add-pet-form').on('submit', function(e) {
            e.preventDefault();
            $.ajax({
                url: "{% url 'add_pet' %}",
                type: 'POST',
                data: $(this).serialize(),
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(response) {
                    showAlert(response.message, 'success');
                    const pet = response.pet;
                    const petItem = `<div class="col-md-4 pet-item" id="pet-${pet.id}">
                                        <h3>${pet.name}</h3>
                                        <p>物种: ${pet.species}</p>
                                        <p>年龄: ${pet.age}</p>
                                        <p>性别: ${pet.gender}</p>
                                        <button class="btn btn-secondary edit-pet-btn" data-id="${pet.id}">编辑</button>
                                        <button class="btn btn-danger delete-pet-btn" data-id="${pet.id}">删除</button>
                                    </div>`;
                    $('#pets-list').append(petItem);
                    $('#add-pet-form')[0].reset();
                },
                error: function(response) {
                    showAlert(response.responseJSON.message, 'error');
                }
            });
        });

        // Delete pet
        $(document).on('click', '.delete-pet-btn', function() {
            const petId = $(this).data('id');
            $.ajax({
                url: `/pets/delete/${petId}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(response) {
                    showAlert(response.message, 'success');
                    $(`#pet-${petId}`).remove();
                },
                error: function(response) {
                    showAlert(response.responseJSON.message, 'error');
                }
            });
        });

        // Edit pet (show edit form)
        $(document).on('click', '.edit-pet-btn', function() {
            const petId = $(this).data('id');
            const petItem = $(`#pet-${petId}`);
            const name = petItem.find('h3').text();
            const species = petItem.find('p:nth-child(2)').text().replace('物种: ', '');
            const age = petItem.find('p:nth-child(3)').text().replace('年龄: ', '');
            const gender = petItem.find('p:nth-child(4)').text().replace('性别: ', '');

            const editForm = `<form class="edit-pet-form" data-id="${petId}">
                                <input type="text" name="name" value="${name}" required>
                                <input type="text" name="species" value="${species}" required>
                                <input type="number" name="age" value="${age}" required>
                                <select name="gender" required>
                                    <option value="Male" ${gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${gender === 'Female' ? 'selected' : ''}>Female</option>
                                </select>
                                <button type="submit" class="btn btn-primary">保存</button>
                                <button type="button" class="btn btn-secondary cancel-edit-btn">取消</button>
                            </form>`;

            petItem.html(editForm);
        });

        // Cancel edit
        $(document).on('click', '.cancel-edit-btn', function() {
            location.reload();
        });

        // Save edited pet
        $(document).on('submit', '.edit-pet-form', function(e) {
            e.preventDefault();
            const petId = $(this).data('id');
            $.ajax({
                url: `/pets/edit/${petId}/`,
                type: 'POST',
                data: $(this).serialize(),
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(response) {
                    showAlert(response.message, 'success');
                    const pet = response.pet;
                    const petItem = `<h3>${pet.name}</h3>
                                     <p>物种: ${pet.species}</p>
                                     <p>年龄: ${pet.age}</p>
                                     <p>性别: ${pet.gender}</p>
                                     <button class="btn btn-secondary edit-pet-btn" data-id="${pet.id}">编辑</button>
                                     <button class="btn btn-danger delete-pet-btn" data-id="${pet.id}">删除</button>`;
                    $(`#pet-${pet.id}`).html(petItem);
                },
                error: function(response) {
                    showAlert(response.responseJSON.message, 'error');
                }
            });
        });
    });
</script>
</body>
</html>
